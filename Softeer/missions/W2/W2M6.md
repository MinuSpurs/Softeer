# W2M6 - Docker 이미지를 AWS EC2에 배포하기

# **기능요구사항**

- AWS EC2에 배포된 후에 서버 주소 (public DNS name)로 들어가면 JupyterLab 인터페이스가 실행되어야 합니다.
- 해당 화면에서 W1에서 만들었던 Jupyter notebook을 선택해서 실행할 수 있어야 합니다.

# **프로그래밍 요구사항**

## **AWS 계정 만들기**

- gmail에서 새로운 이메일을 생성하세요. (추천: [aws.danolee@gmail.com](mailto:aws.danolee@gmail.com) 처럼 aws.을 prefix로 사용하는 계정을 만들어서 사용하면 편합니다.)
- 새로 생성한 이메일로 aws 계정을 생성하세요. 새로운 계정에서 free-tier EC2 인스턴스를 12개월 동안 무료로 사용할 수 있습니다.

## **AWS free-tier EC2 생성하기**

- free-tier EC2 인스턴스를 생성하세요.
    <img width="1066" height="322" alt="image" src="https://github.com/user-attachments/assets/0bc6c94a-4d24-4769-84e8-e6fa2538c3d1" />

    
    - 먼저 AWS에 로그인 한 후 free-tier EC2 인스턴스를 설치해준다.
    - 여기서는 free-tier로 사용할 수 있는 Ubuntu Server 24.04 LTS를 사용한다.
    

    <img width="706" height="182" alt="image 2" src="https://github.com/user-attachments/assets/ca5cafca-8603-4836-a09f-a7bdb10404ed" />
    <img width="796" height="191" alt="image 1" src="https://github.com/user-attachments/assets/a18308f4-6db7-4ee8-8aac-c5d5cce4f238" />

    
    - 인스턴스 유형은 t2.micro를 사용했고, 스토리지는 free-tier maximum인 30GiB로 선택했다.
    - 키페어는 새로 생성하여 이용했다.
    
    <img width="783" height="254" alt="image 3" src="https://github.com/user-attachments/assets/07dedfcf-f705-4ebb-bbc6-2b942875865e" />

    - 보안 그룹은 사용해야 할 jupyter notebook과 후에 사용할 hadoop 포트를 설정하여 사용했다.
    
- 반드시 **User-data**를 사용해서 Docker를 설치하고 구성하세요.
    
    ```go
    #!/bin/bash
    sudo apt update
    sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
    sudo apt update
    sudo apt install -y docker-ce
    ```
    
    - Docker를 설치하는 user-data를 설정
        - 인스턴스 첫 생성시 docker가 install 된다
    
<img width="793" height="210" alt="image 4" src="https://github.com/user-attachments/assets/7ba5717b-cd93-4869-8a4b-f84270802311" />
    
- 위 사진과 같이 W2M6 인스턴스가 생성된다 (Docker 파일 설치중이라 시간 소요가 조금 있음)
- hadoop_test는 혼자 hadoop을 하려 만든 다른 인스턴스
    
<img width="329" height="40" alt="image 5" src="https://github.com/user-attachments/assets/a6eddeed-7b51-436d-89f8-3a1396e143e6" />


    
- ssh로 접속해 확인한 결과 docker가 정상적으로 설치된 것을 확인할 수 있다

## **Docker Image 생성하기**

- Local에서 Docker Desktop을 이용해서 AWS EC2에 배포할 docker container image를 생성하세요.
    - 먼저 Docker 파일을 설치해준 뒤 Sign up을 하여 Docker hub에 정상적으로 들어가지는지 확인한다.
    - 그 다음 터미널에서 docker —version 명령어를 통해 정상적으로 되는지 확인해준다.
    <img width="648" height="69" alt="image 6" src="https://github.com/user-attachments/assets/6e779bba-6180-427b-afb9-810574bb6bf8" />


    
    - Docker Desktop이 정상적으로 설치된 것을 확인할 수 있다.
    
    <img width="966" height="156" alt="image 7" src="https://github.com/user-attachments/assets/a7161782-a9ef-49fd-b8e8-5294b086b74d" />
    
    - Ubuntu:22.04를 기반으로 임시 컨테이너를 실행한다.
        - docker run: 새 컨테이너를 실행하는 명령어
        - -i: 터미널에서 컨테이너에 명령어를 입력할 수 있게 해줌
        - -t: 가상 터미널을 할당 (컨테이너 내부에서 쉘 프롬프트를 볼 수 있게 함)
        - —name: 컨테이너에 이름을 부여함. 나중에 컨테이너에 다시 접속하거나 삭제할 때 사용
        - ubuntu:22.04: 사용할 도커 이미지 (여기서는 EC2 인스턴스와 맞췄음)
        - /bin/bash: 컨테이너가 시작될 때 실행할 명령어. bash 쉘을 통하여 컨테이너 내부에서 대화형으로 작업할 수 있음
        
        ```bash
        apt-get update && apt-get install -y python3 python3-pip curl build-essential
        ```
        
        - 패키지 목록을 업데이트하고, Python 3, pip, curl, 빌드 도구들을 설치해줌
            <img width="473" height="71" alt="image 8" src="https://github.com/user-attachments/assets/8e5bdb02-e0f8-41b7-8a28-36cc66e184f6" />

            <img width="529" height="75" alt="image 9" src="https://github.com/user-attachments/assets/0d52f7c1-b7ab-49b3-90d1-cd0607d07ad2" />

            
        - 설치가 정상적으로 됐음을 확인할 수 있다.
        
        ```bash
        pip3 install jupyter numpy pandas matplotlib
        ```
        
        - 이 명령어는 Jupyter Notebook과 데이터 분석에 많이 사용되는 NumPy, Pandas, Matplotlib 라이브러리를 설치한다.
            <img width="324" height="254" alt="image 10" src="https://github.com/user-attachments/assets/160fe4f3-7e95-4b50-9b4f-b19b4047df17" />

            
        - jupyter —version을 통하여 정상적으로 설치됐는지 확인해준다.

            
        - app이라는 폴더를 만들어 이동한다. (작업할 파일들 저장 용도)
          <img width="345" height="40" alt="image 11" src="https://github.com/user-attachments/assets/256140bf-f672-4c9f-b7d1-f8c462f24662" />
        
        ```bash
        jupyter notebook --allow-root --ip=0.0.0.0 --port=8888 --no-browser --NotebookApp.token=''
        ```
        
        - 이 명령어를 실행하여 Jupyter Notebook의 로그와 함께 접속 가능한 URL을 확인
        - 하지만 포트 매핑을 하지 않았기 때문에 로컬에서 접속 불가능
        <img width="899" height="589" alt="image 12" src="https://github.com/user-attachments/assets/57914463-85e9-4fa1-832a-0fda8bf6bddc" />

        
    
    - 정상적으로 컨테이너 내부에서 jupyter notebook 실행시킨 걸 확인했으니 Dockerfile 작성
        - 그 전에 컨테이너에서 나간 뒤에 방금 생성한 임시 컨테이너를 제거해준다.
            <img width="886" height="88" alt="image 13" src="https://github.com/user-attachments/assets/ef435c44-982f-4c88-b695-6e56622dd5ca" />
   
        
        ```bash
        docker rm temp-jupyter-setup
        ```
        
        - 정상적으로 컨테이너를 삭제됐음을 확인
        

## **Docker Image 배포하기**
<img width="914" height="429" alt="image 14" src="https://github.com/user-attachments/assets/7f720fae-a254-4942-8c1e-0ff112a1523e" />


- 임시 컨테이너 안에서 성공적으로 실행했던 명령어들을 순서대로 Dockerfile에 옮겨 적었다.
    - 이번에는 Jupyter Notebook이 사용하는 포트인 8888을 노출시켜줌
    <img width="891" height="371" alt="image 15" src="https://github.com/user-attachments/assets/4cb17ef3-de87-47a9-8d3e-56365b0f6e68" />

    
- Docker build를 통해 이미지를 생성했다.

```bash
docker login
```

- 이미지를 생성한 후에 Docker Hub에 로그인 해준다.
    <img width="812" height="134" alt="image 16" src="https://github.com/user-attachments/assets/905e61f0-4c8d-492d-ba8b-b566aed6fc9f" />
    
- Docker 이미지 태그 설정

```bash
docker tag my-jupyter-image:latest gapbu123/my-jupyter-repo:latest
```

- Docker Hub 레포지토리 이름으로 태그를 변경해준다.
    - Docker Hub에 만들 레포지토리도 같이 만들어준다.
- Docker 이미지 Docker Hub에 Push

```bash
docker push gapbu123/my-jupyter-repo:latest
```

- docker push를 통해 Docker Hub에 이미지를 업로드

- ssh로 EC2에 접속하여 다시 docker login을 해준다.
<img width="809" height="311" alt="image 17" src="https://github.com/user-attachments/assets/b85e1ad7-2492-4b8d-89cd-25986430d5e1" />

<img width="899" height="73" alt="image 18" src="https://github.com/user-attachments/assets/7131d174-f7a0-4dc0-a87e-ae9a65c5e252" />


- 그러나 이어서 pull을 하려 하면 docker 그룹에 포함되어 있지 않기 때문에 docker 명령어를 사용할 수 없다고 나옴

```bash
sudo usermod -aG docker $USER
```

- usermod를 통해 계정 권한을 수정
- -aG docker 현재 로그인된 사용자($USER)를 docker 그룹에 추가(-a)하고 기존 그룹은 유지(-G)
- 변경사항 적용을 위해 세션 다시 시작
    <img width="595" height="57" alt="image 19" src="https://github.com/user-attachments/assets/612e581a-bbcb-4f1d-95c1-2dd6d17ab4d0" />
    
- docker 명령어는 실행되지만 EC2 인스턴스 아키텍처 형식 이미지가 없다는 오류가 발생했다
    - Mac M2에서 빌드된 ARM64 아키텍처용 이미지만 Docker Hub에 올라가 있음

```bash
docker buildx build --platform linux/amd64 -t gapbu123/my-jupyter-repo:amd64-latest . --load
```

- 다른 명령어로 이미지 빌드
    - docker buildx build: buildx 기능을 사용하여 이미지 빌드
    - —platform linux/amd64: AMD64 아키텍처용 이미지를 빌드하도록 실시 (EC2 인스턴스 아키텍처)
    - -t: 태그를 작성해줌
    - —load: 빌드된 이미지를 로컬 Docker 이미지 저장소로 로드하여 docker images에서 확인할 수 있게 함
    <img width="895" height="540" alt="image 20" src="https://github.com/user-attachments/assets/a2c18a61-30fb-4db6-9d52-bef49015813b" />

    
- build와 push까지 모두 성공했으니, 다시 EC2에 접속하여 pull을 한다.
    <img width="641" height="156" alt="image 21" src="https://github.com/user-attachments/assets/de5758f1-fcbf-4e40-b39a-214ac0ca8a12" />

    
- 이번엔 오류없이 정상적으로 해결했다.

# **예상결과 및 동작예시**

Jupyter notebook을 실행할 수 있어야 합니다.

- Docker 컨테이너 실행

```bash
docker run -d -p 8888:8888 gapbu123/my-jupyter-repo:amd64-latest
```

- 컨테이너를 실행시키는 명령어를 실행한 뒤 [http://[퍼블릭 DNS 주소]:8888](http://ec2-3-106-215-122.ap-southeast-2.compute.amazonaws.com:8888/tree) 로 접속하여 jupyter notebook이 정상적으로 실행되는지 확인
<img width="1212" height="286" alt="image 22" src="https://github.com/user-attachments/assets/afe52a1f-8d3d-43eb-aa40-7b240fc50e15" />

- 정상적으로 아무 파일이 없는 jupyter notebook이 실행되는 것을 확인했다.

- 이제 Jupyter Notebook이 실행되는 것을 확인했으니, W1에 있는 ipynb 파일들을 옮겨보는 작업을 해야한다.
    - 이 작업을 수행하기 위해 실행중인 jupyter notebook을 종료해준다.
        
        ```bash
        docker ps
        ```
        
        ```bash
        docker stop [container ID]
        ```
        
    - 컨테이너의 id를 찾아서 종료해준다.
- scp를 통하여 로컬에 있는 W1 폴더를 EC2 인스턴스 안으로 전송해준다.

```bash
scp -i /path/to/your/key.pem -r ./W1 ubuntu@your-ec2-public-ip:/home/ubuntu/jupyter_files
```

- 그 후 다시 인스턴스에 접속하면, 아래 사진과 같이 정상적으로 파일이 옮겨짐을 확인할 수 있다.
<img width="843" height="96" alt="image 23" src="https://github.com/user-attachments/assets/acaa15c5-aef9-4587-a836-39b2634fe356" />

- 이제 다시 docker run을 통해서 jupyter notebook을 실행시켜본다.

```bash
docker run -d -p 8888:8888 -v /home/ubuntu/jupyter_files:/app gapbu123/my-jupyter-repo:amd64-latest
```

- -v /home/ubuntu/jupyter_files:/app 을 통해 볼륨 마운트를 설정
    - Dockerfile에서 WORKDIR /app으로 설정했기 때문에, 파일들을 여기서 실행시킬 수 있게 해야한다.
    <img width="1191" height="542" alt="image 24" src="https://github.com/user-attachments/assets/732985f9-db3a-4e7b-b8b0-016c2348e754" />

    
- 정상적으로 W1의 파일들이 마운트됐음을 확인할 수 있다.
<img width="1201" height="588" alt="image 25" src="https://github.com/user-attachments/assets/f37a923f-994f-4a97-b2c8-b3d785681f79" />


- 실행도 정상적으로 됐음을 확인할 수 있다.

# **팀 활동 요구사항**

- Docker를 사용하는 이유가 뭘까요?
- 어떤 점은 더 불편한가요?
- 이번 미션에서는 하나의 EC2에 하나의 Docker container를 배포했습니다. 만약에 여러대의 EC2에 여러 개의 컨테이너를 배포해야 한다면 어떻게 해야 할까요?

# **추가 요구 사항**

- W2에서 만든 노트북도 실행할 수 있도록 만드세요.
    - scp를 통해 W2M5.ipynb를 인스턴스로 전송한다.
    - 인스턴스에 접속해 컨테이너를 실행시켜서 Jupyter Notebook에 접속한다.
        <img width="1274" height="837" alt="image 26" src="https://github.com/user-attachments/assets/dc39f057-4fd4-4a29-84d9-bc27ac8349b8" />

        
    - 최종 실행시켜보며 잘 돌아가는지 확인
